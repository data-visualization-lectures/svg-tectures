Q.supabaseのアカウント情報を用いてnode.jsでクッキーを発行する場合、注意すべきことはありますか？すべて挙げてください。



A. ざっくりいうと「Supabaseのアカウント情報＝認証情報・鍵・JWT」をそのまま雑にクッキーに入れるのは危険ポイントだらけです。

Node.js でクッキーを発行するときに、最低限おさえておくべき注意点をできるだけ体系的に全部出しておきます。



------





## **1. 秘密鍵・サービスロールキーをクッキーに入れない**





- SUPABASE_SERVICE_ROLE_KEY や SUPABASE_SECRET などの**秘密鍵**は、

  

  - クッキーに入れない
  - レスポンスボディにも出さない
  - localStorage にも書かない

  

- クライアントに渡して良いのは **Anon Key** か、Supabase が発行した **JWT アクセストークン** など「公開前提のトークン」のみ。





------





## **2. JWT・セッショントークン系をクッキーに入れるときのフラグ**





Supabaseのセッショントークン(JWT)をクッキーで持つ場合、以下はほぼ必須です:



- HttpOnly: true

  

  - JSから読み取れないようにする（XSSで盗まれないように）

  

- Secure: true

  

  - HTTPS 通信時のみ送信（本番環境では必須）

  

- SameSite の設定

  

  - 同一ドメインのみなら SameSite=Lax or Strict
  - auth.example.com → .example.com のような**サブドメイン間で共有したい場合**は、SameSite=None; Secure が必要

  

- Path=/ など、不要に広すぎないパスにする（本当に全サイトで使う必要があるか考える）

- Domain の設定

  

  - auth.dataviz.jp で .dataviz.jp ドメインのクッキーを発行したいなら、Domain=.dataviz.jp を付ける
  - ドメイン指定をミスると、想定サイトにクッキーが送られない or 逆に余計なサブドメインにも送られてしまう

  





------





## **3. クッキーの中身そのものへの配慮**







### **(1) 平文トークンをそのまま入れない**





- 可能なら

  

  - ランダムなセッションIDだけをクッキーに入れる
  - 実際の Supabase セッション情報はサーバ側の DB/メモリに持つ

  

- JWT をそのまま入れる場合も、

  

  - 署名・検証（jwt.verify）を毎回行う
  - 想定以上の情報（メールアドレス、権限など）が入っていることを理解しておく

  







### **(2) 署名付き・暗号化付きクッキーを検討**





- クッキーの改ざん検出のために、

  

  - HMAC で署名する
  - cookie-signature や iron-session のようなライブラリを使う

  

- センシティブ情報を入れる必要がある場合は暗号化も検討





------





## **4. 有効期限・リフレッシュ・ログアウト周り**





- Expires / Max-Age をどうするか

  

  - 短すぎると UX が悪い
  - 長すぎると乗っ取り時の被害が大きくなる

  

- Supabase のセッション/リフレッシュトークン戦略に合わせる

  

  - アクセストークンは短命
  - リフレッシュトークンはより長く保持

  

- ログアウト時には

  

  - サーバ側セッションの無効化
  - クッキーの Expires を過去にして削除
  - Supabase側の signOut も適宜呼ぶ

  





------





## **5. Node.js 実装でのよくある落とし穴**







### **(1) サーバ・クライアントの両方でクッキーを触ってしまう**





- SSR（Next.js など）で

  

  - サーバ側では Set-Cookie だけを行う
  - クライアント側 JS ではなるべくクッキーを触らない（特に機密トークン）

  

- 二重管理になると「どっちが正なのか」「いつ更新されたのか」が分かりにくくなる







### **(2) レスポンスヘッダの重複・上書き**





- Node.js(Express, Next.js, Vercel Functions等)で、複数箇所で Set-Cookie を書いて上書きしてしまうケース

  

  - res.setHeader('Set-Cookie', ...) ではなく res.append/配列で複数指定する必要がある場面もある

  

- 既存のクッキーを残したまま追加するか、全部上書きするかを意識する







### **(3) 本番と開発での挙動差分**





- Secure フラグが付いていると、http://localhost ではクッキーが送られない

  

  - 開発では Secure をオフにする or HTTPSローカル（mkcert, localhost.run等）を使う

  

- ドメイン設定が localhost と本番ドメインで変わるため、環境ごとの分岐処理が必要





------





## **6. CSRF・XSS などWebセキュリティ全般**







### **(1) CSRF対策**





- クッキー認証（特に SameSite=None）＋状態変更系APIがあるときは CSRF 対策必須

  

  - CSRFトークン (Double-Submit Cookie など)
  - SameSite=Lax/Strict で抑える

  

- SupabaseのAPIを直接叩く場合でも、バックエンドがプロキシする場合でも、

  「クッキーが自動で付く」＝「CSRF攻撃の余地がある」ことに注意







### **(2) XSS対策**





- HttpOnly でクッキーを守るのは「最後の砦」

- そもそもアプリ側での

  

  - エスケープ不足

  - 危険な innerHTML／dangerouslySetInnerHTML

  - 外部スクリプトの扱い

    をきちんと見直す

  





------





## **7. Supabase側のポリシー・権限設計との整合**





- JWT の中の role・aud・カスタムクレーム などと、

  RLS(行レベルセキュリティ)・ポリシーの設計が一致しているか

- クッキーを盗まれた場合に、

  

  - どこまでのデータが読み書きできてしまうか
  - それを前提に、RLS/権限を「最小限」にしておくこと

  





------





## **8. ログ・エラーメッセージでの情報漏えい**





- JWT やクッキーの値をそのままログに出さない
- 例外処理・エラー画面にトークン内容を表示しない
- デバッグ用に console.log(cookie) などを入れっぱなしにしない





------





## **9. プライバシー・法律面の注意**





- クッキーが**追跡**や**個人情報**扱いになる場合、

  

  - Cookieバナー/Cookieポリシー
  - プライバシーポリシーへの明記

  

- 欧州向け・広告タグ併用などの場合は特に要注意





------





## **10. サブドメイン間でのクッキー共有特有の注意点**





（auth.dataviz.jp → .dataviz.jp などを意識していると思うので、ここだけ少し詳しめに）



- Domain=.dataviz.jp にすると、

  

  - auth.dataviz.jp, svg-tectures.dataviz.jp など**全部のサブドメインに送られる**
  - 意図しないサービスにもトークンが送られるリスクが増える

  

- その状態で「片方のサービスだけ脆弱」だと、その1サービスのXSSから全サブドメインのセッションが抜かれる可能性

- 本当に共有したい情報は何かを慎重に決める

  

  - 例: 「ログイン済みフラグ」程度を共有して、実セッションは各サブドメイン内で別管理、など

  





------





## **まとめ**





Supabase＋Node.jsでクッキーを発行するときの主な注意点は：



1. 秘密鍵・サービスキーは絶対にクッキーに入れない
2. JWT/セッショントークンをクッキーで扱うときは HttpOnly/Secure/SameSite/Domain/Path を慎重に設定
3. クッキーの中身は最小限にし、改ざん検知（署名）や暗号化を検討
4. 有効期限・リフレッシュ・ログアウト時の削除をきちんと設計
5. Node.js 実装でのヘッダ上書き・環境差分・クライアントとの二重管理に注意
6. CSRF/XSS などの基本的なWebセキュリティ対策を前提にする
7. SupabaseのRLS/ポリシー設計と合わせて、トークンが盗まれた場合の被害を最小化
8. ログ・エラーで認証情報を漏らさない
9. プライバシー・法令対応（Cookieポリシーなど）
10. サブドメイン共有時は「どこまで共有するか」を本当に必要な範囲に絞る



