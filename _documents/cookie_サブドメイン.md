# サブドメイン間でのセッション共有において、特に注意すべき点



### 1. セキュリティリスクの広がり (最も重要)

共有クッキー（

```
Domain=.dataviz.jp
```

）は、**`\*.dataviz.jp` のすべてのサブドメイン** に送信されます。



- **リスク**: もし 

  ```
  blog.dataviz.jp
  ```

   

  や

   

  ```
  test.dataviz.jp
  ```

   

  など、セキュリティ対策が甘い（あるいは開発中の）サブドメインが一つでもあれば、

  そこにあるXSS脆弱性を突かれて、認証セッション全体（アクセストークン）が盗まれる

   

  可能性があります。

- **対策**: 

  ```
  dataviz.jp
  ```

   

  以下の全てのサブドメインサービスにおいて、高いセキュリティ基準（XSS対策、依存ライブラリの管理など）を維持する必要があります。

### 2. データサイズの上限

クッキーにはブラウザごとに約4KB（4096バイト）というサイズ制限があります。

- **現状**: Supabaseのセッション情報はJSONですが、今回それを **Base64エンコード** しているため、元のサイズより **約33%** 増大しています。

- **注意**: ユーザーのメタデータ（

  ```
  user_metadata
  ```

  ）などに大量の情報を詰め込むと、突然ログインできなくなる（クッキーが保存されなくなる）可能性があります。セッションには最小限のID情報のみを持たせ、詳細はDBから引く設計を維持してください。

### 3. ログアウトの挙動

- ログアウト処理が走ると、

  ```
  .dataviz.jp
  ```

   

  のクッキーを削除 (

  ```
  Max-Age=0
  ```

  ) します。

- これは正しく動作しますが、もし他のサブドメインで「独自にメモリ内やLocalStorageにセッションをキャッシュしている」場合、ブラウザをリロードするまでログアウトが反映されないタイムラグが発生することがあります。