# 認証不具合の原因調査結果：認証サーバーの設定不備（最終報告）

`svg-tectures.dataviz.jp` でログインループが発生する原因は、**認証サーバー（`auth.dataviz.jp`）が発行したクッキーが、サブドメインの `svg-tectures.dataviz.jp` に共有されていないこと** で確定しました。

## 現象のまとめ
1. **直接ログイン時**: `auth.dataviz.jp` に直接アクセスしてログインすると、クッキー (`sb-...`) は作成される。Domain も `.dataviz.jp` になっている（ように見える）。
2. **リダイレクト連携時**: `svg-tectures` からリダイレクトしてログインし、戻ってきた直後には、`svg-tectures` 側で **`sb-...` クッキーが一切見つからない**（`Cookie not found`）。
3. **結果**:
    - `auth` 側は「ログイン済み」と判断し、`svg-tectures` へリダイレクトする。
    - `svg-tectures` 側は「クッキーがない」と判断し、再度 `auth` へリダイレクト（または認証処理待ち状態）となる。

## 原因の特定（パターン2：認証サーバー設定不備）

クッキーが共有されていない（見えていない）理由は以下のどちらかです。

### A. Domain属性の設定不備（最有力）
「直接ログイン時」と「リダイレクト（OAuth/SSO）時」で、認証サーバーの処理ルートが異なり、**リダイレクト時には `Domain=.dataviz.jp` が付いていないクッキーが発行されている** 可能性があります。
そのため、`auth` ドメインではログイン状態が維持されるが、`svg-tectures` ドメインにはクッキーが届いていません。

### B. SameSite属性の影響
`SameSite=Lax` の挙動により、リダイレクト直後のリクエストでクッキーが送信されていない可能性がありますが、同ドメイン内のリダイレクト(`GET`)であれば通常は送信されます。可能性としては A より低いです。

## 必要な対応（認証サーバー担当者へ）

`dataviz-auth` リポジトリのクッキー発行ロジック（`createServerClient`等）を修正してください。

1. **Domain設定の徹底**: どのような経路（直接/リダイレクト）であっても、必ず `cookieOptions: { domain: '.dataviz.jp' }` が適用されるようにする。
2. **HttpOnlyの解除**: `svg-tectures` のようなクライアントJSからセッションを読むため、`httpOnly: false` に設定する（もし設定されていれば）。

本リポジトリ（`svg-tectures`）側のクライアント実装は、共有クッキーさえ見えれば動作するように修正・検証済みです。
